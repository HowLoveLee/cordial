{% extends 'base.html' %}

{% block content %}
<div class="registration-process" id="registrationProcess">
    <h1>Exam Registration</h1>
    <a href="{% url 'student_dashboard' %}" class="button">No, Go Back</a>

    <form method="POST" id="registrationForm">
        {% csrf_token %}
        <div class="container exam-select" id="container1">
            <!-- Select an Exam -->
            <label for="exam_id">Select Exam:</label>
            <select name="exam_id" id="examSelect" required>
                <option value="">-- Select an Exam --</option>
                {% for exam in exams %}
                <option value="{{ exam.id }}">{{ exam.name }}</option>
                {% endfor %}
            </select>
            <button type="button" class="next-btn">Next</button>
        </div>
        
        <div class="container location-select" id="container2" style="display: none;">
            <button type="button" class="back-btn">Back</button>
            <label for="location_id">Select Location:</label>
            <select name="location_id" id="locationSelect" required>
                <option value="">-- Select a Location --</option>
            </select>
            <button type="button" class="next-btn">Next</button>
        </div>
        
        <div class="container date-select" id="container3" style="display: none;">
            <button type="button" class="back-btn">Back</button>
            <!-- Select Date -->
            <label for="selected_date">Select Date:</label>
            <input type="date" name="selected_date" id="dateSelect" required>
            <!-- Select Time -->
            <label for="selected_time">Select Time:</label>
            <select name="selected_time" id="timeSelect" required>
                <option value="">-- Select a Time --</option>
            </select>
            <button type="submit">Register</button>
        </div>
    </form>
    
</div>

<div class="confirmation" id="confirmation" style="display: none;">
    <h1>Registration Confirmation</h1>
    <p><strong>Exam:</strong> <span id="confirmExam"></span></p>
    <p><strong>Location:</strong> <span id="confirmLocation"></span></p>
    <p><strong>Date:</strong> <span id="confirmDate"></span></p>
    <p><strong>Time:</strong> <span id="confirmTime"></span></p>
    <button onclick="goToDashboard()">Back to Dashboard</button>
</div>

<script>
    document.getElementById("examSelect").addEventListener("change", function () {
        const examId = this.value;
    
        if (!examId) {
            // Clear locations and times if no exam is selected
            document.getElementById("locationSelect").innerHTML = '<option value="">-- Select a Location --</option>';
            document.getElementById("timeSelect").innerHTML = '<option value="">-- Select a Time --</option>';
            return;
        }
    
        // Fetch locations and times dynamically
        fetch(`/get_locations/${examId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch data.');
                }
                return response.json();
            })
            .then(data => {
                const locationSelect = document.getElementById("locationSelect");
                locationSelect.innerHTML = '<option value="">-- Select a Location --</option>';
                data.locations.forEach(location => {
                    locationSelect.innerHTML += `<option value="${location.id}">${location.name}</option>`;
                });
    
                const timeSelect = document.getElementById("timeSelect");
                timeSelect.innerHTML = '<option value="">-- Select a Time --</option>';
                data.available_times.forEach(time => {
                    timeSelect.innerHTML += `<option value="${time}">${time}</option>`;
                });
            })
            .catch(error => {
                console.error('Error fetching locations and times:', error);
            });
    });
    document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.querySelector("#dateSelect");
        
        // Initialize Flatpickr
        const flatpickrInstance = flatpickr(dateInput, {
            dateFormat: "Y-m-d", // Backend-compatible format
            minDate: "today",    // Prevent past dates
        });
    
        // Open the calendar by default
    });
    document.addEventListener("DOMContentLoaded", function () {
        const containers = document.querySelectorAll(".container"); // Select all containers
        let currentContainerIndex = 0; // Start with the first container
    
        function showContainer(index) {
            // Hide all containers
            containers.forEach((container, i) => {
                container.style.display = i === index ? "block" : "none";
            });
        }
    
        // Add event listeners for "Next" buttons
        document.querySelectorAll(".next-btn").forEach((btn, index) => {
            btn.addEventListener("click", function () {
                if (currentContainerIndex < containers.length - 1) {
                    currentContainerIndex++;
                    showContainer(currentContainerIndex);
                }
            });
        });
    
        // Add event listeners for "Back" buttons
        document.querySelectorAll(".back-btn").forEach((btn, index) => {
            btn.addEventListener("click", function () {
                if (currentContainerIndex > 0) {
                    currentContainerIndex--;
                    showContainer(currentContainerIndex);
                }
            });
        });
    
        // Show the first container initially
        showContainer(currentContainerIndex);
    });
    
</script>
{% endblock %}
